name: Reusable Build-Test-Push Workflow

on:
  # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#onworkflow_callinputsinput_idtype
  # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#onworkflow_call
  # https://docs.github.com/en/actions/using-workflows/reusing-workflows
  workflow_call:
    inputs:
      environment-name:
        type: string
        description: environment to deploy to
        required: true
      catalogs-service-path:
        description: "Catalogs service path"
        required: true
      tests-path:
        description: "Tests path"
        required: true
      project-path:
        description: "Project path"
        required: true
      docker-file-path:
        description: "Docker file path"
        required: true
      registry:
        description: "Docker registry to push"
        required: true
        default: "ghcr.io"

jobs:
  build-test-push:
    # https://github.com/actions/runner-images/blob/main/images/linux/Ubuntu2204-Readme.md
    # https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners
    runs-on: ubuntu-latest

    #https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstrategyfail-fast
    continue-on-error: false

    steps:

      # https://docs.github.com/en/actions/learn-github-actions/contexts#github-context
      # The `default working directory` on the runner for `steps`, and the default location of your repository when using the checkout action
      # it is `defualt root path` if we don't specify a working directory
      - name: Ls default workspace for steps
        run: ls -R ${{ github.workspace }}

        # https://docs.github.com/en/actions/learn-github-actions/variables#using-contexts-to-access-variable-values
      - name: Job Info
        run: |
          echo "job name is: ${{ github.job }}"
          echo "branch name is: ${{ github.ref_name }}"
          echo "workspace is: ${{ github.workspace }}"
          echo "job name is: ${{ github.job }}"
          echo "branch name is: ${{ github.ref_name }}"
          echo "project-path is: ${{ inputs.project-path }}"
          echo "tests-path is: ${{ inputs.tests-path }}"

      - name: Check Inputs
        run: |
          if [ -z ${{ inputs.environment-name }} ]
             then echo "environment-name is empty, action cancelled..."
                  exit 1
          fi

        # https://github.com/cycjimmy/semantic-release-action/issues/6
        # https://github.com/actions/checkout#push-a-commit-using-the-built-in-token
        # https://stackoverflow.com/questions/750172/how-do-i-change-the-author-and-committer-name-email-for-multiple-commits
        # https://github.com/semantic-release/semantic-release/issues/1208
        # https://github.com/orgs/community/discussions/26560
        # https://github.com/semantic-release/semantic-release/blob/b9b5c7689f0acdfdc079c839db0fcf78339745e2/index.js#L92
        ## https://github.com/actions/checkout/issues/439#issuecomment-965968956
        # get latest remote change because sematic-release in `verifyConditions` event checks local branch has latest remote branch changes, for preventing: The local branch `something` is behind the remote one, therefore a new version won't be published.
        # By default checkout@v3, will check branch on ref/SHA that triggered in starting workflow, so if inner a job in the workflow we change HEAD of repository by changing code, subsequent jobs don't get these commits and they get ref/SHA that triggered in starting workflow
      - name: Check out code
        uses: actions/checkout@v3
        with:
          # https://github.com/actions/checkout#fetch-all-history-for-all-tags-and-branches
          # Only a single commit is fetched by default, for the ref/SHA that triggered the workflow. Set fetch-depth: 0 to fetch all history for all branches and tags
          fetch-depth: 0
          ref: ${{ github.ref_name }}
      - run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Call Composite Action app-version
        uses: ./.github/actions/app-version
        if: ${{ github.event_name != 'pull_request' && success() }}
        id: app-version-step
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Call Composite Action build-test
        uses: ./.github/actions/build-test
        if: ${{ success() }}
        id: build-test-step
        with:
          application-version: ${{ steps.app-version-step.outputs.application-version }}
          project-path: "ecommerce.sln"
          tests-path: "ecommerce.sln"
          unit-test-filter: "(Category=Unit&FullyQualifiedName~UnitTests&FullyQualifiedName~ECommerce.Services)"
          integration-test-filter: "(Category=Integration&FullyQualifiedName~IntegrationTests&FullyQualifiedName~ECommerce.Services)|(Category=EndToEnd&FullyQualifiedName~EndToEndTests)"
          exclude-coverage: "[BuildingBlocks.*]*%2c[ECommerce.Services.Shared]*"
          # wildcard search for files with the ".cobertura.xml" extension in all subdirectories of the current directory
          # https://www.jamescroft.co.uk/combining-multiple-code-coverage-results-in-azure-devops/
          # https://stackoverflow.com/questions/53255065/dotnet-unit-test-with-coverlet-how-to-get-coverage-for-entire-solution-and-not
          reports-path: ${{ github.workspace }}/**/*.cobertura.xml
          reports-output-path: ${{ github.workspace }}/output/test-results
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Call Composite Action publish
        uses: ./.github/actions/publish
        if: ${{ github.event_name != 'pull_request' && success() }}
        with:
          application-version: ${{ steps.app-version-step.outputs.application-version }}
          token: ${{ inputs.release-version }}
          catalogs-service-path: ${{ inputs.catalogs-service-path}}
          customers-service-path: ${{ inputs.customers-service-path }}
          identity-service-path: ${{ inputs.identity-service-path }}

      - name: Call Composite Action docker-build-push
        uses: ./.github/actions/docker-build-push
        if: ${{ github.event_name != 'pull_request' && success() }}
        id: docker-build-push-step
        with:
          application-version: ${{ steps.app-version-step.outputs.application-version }}
          registry: ${{ inputs.registry }}
          registry-username: ${{ github.actor }}
          registry-password: ${{ secret.GITHUB_TOKEN }}
          registry-endpoint: ${{ github.repository }}
          catalogs-image: "catalogs-service"
          customers-image: "customers-service"
          identity-image: "identity-service"
          catalogs-docker-file-path: ${{ inputs.catalogs-docker-file-path }}
          customers-docker-file-path: ${{ inputs.customers-docker-file-path }}
          identity-docker-file-path: ${{ inputs.identity-docker-file-path }}
